#!/usr/bin/lua

local json = require 'jsonc'
local uci = require('simple-uci').cursor()
local ddutil = require 'ffda-domain-director.util'
local location = require 'ffda-location'

-- Queries the director with supplied list of WiFi networks.
-- Returns director response as string.
function query_director(networks)
  local wifi_json = location.generate_wifi_json(location.get_available_wifi_networks())
  local handle = io.popen("wget -T 30 -qO -  --post-data=wifis=" ..location.urlencode(wifi_json) .. " "..ddutil.get_director_url())
  local return_str =  handle:read("*a")
  handle:close()
  return return_str
end

-- Saves target domain in UCI
function save_target_domain(domain_name)
  uci:set("ffda", "director", "target", domain_name)
  uci:commit("ffda")
end

-- Saves switch-after time (as UNIX epoch) in UCI
function save_switch_time(switch_time)
  uci:set("ffda", "director", "switch_after", switch_time)
  uci:commit("ffda")
end

-- Updates target domain by querying a remote director
function update_domain()
  local response = json.parse(query_director())
  if response == nil then
    print("Received invalid response. Exiting.")
    return
  end
  local domain = response.node_information.domain.name
  local switch_time = response.node_information.domain.switch_time

  if ddutil.firmware_is_multidomain() then
    if ddutil.check_domain_exists(domain) then
      print("Domain "..domain.." is valid, setting as proposed domain")
    else
      print("Domain "..domain.." is invalid, aborting")
      return
    end
  else
    print("Firmware has no multidomain support. Skipping domain validation.")
  end

  save_target_domain(domain)
  save_switch_time(switch_time)
end

if not ddutil.is_enabled() then
  print("Domain director is disabled.")
  return
end

update_domain()
